<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimizador de Menús y Costes - V Gama</title>
    <!-- Incluir Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Estilos personalizados para la tabla de resultados */
        .table-header {
            background-color: #1a4d31; /* Un verde oscuro corporativo */
            color: white;
        }
        .data-row:nth-child(even) {
            background-color: #e6f1ec;
        }
        .data-row:hover {
            background-color: #d1e5d7;
            transform: scale(1.01);
            transition: all 0.2s;
        }
        .product-button {
            transition: all 0.2s;
            cursor: pointer;
        }
        .product-button:hover {
            transform: translateX(5px);
            background-color: #d1fae5;
        }
        .product-button.active {
            background-color: #059669; /* Verde esmeralda para el activo */
            color: white;
            font-weight: 700;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        
        <!-- Header -->
        <header class="p-6 bg-gray-900 text-white rounded-t-xl">
            <h1 class="text-3xl font-extrabold tracking-tight">Gestor de Rentabilidad V Gama</h1>
            <p class="text-gray-400 mt-1">Simulador de costes y pedido simplificado. Producto base: 1 kg / 12,00 €.</p>
        </header>

        <div class="flex flex-col lg:flex-row">
            
            <!-- Sidebar / Lista de Productos y Carrito -->
            <aside class="lg:w-1/4 p-6 border-r border-gray-200 bg-gray-50">
                <!-- SECCIÓN DE PRODUCTOS PARA ANÁLISIS -->
                <h2 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">1. Seleccionar Producto para Análisis</h2>
                <div id="product-list" class="space-y-3">
                    <!-- Los botones de productos se insertarán aquí por JS -->
                </div>

                <!-- SECCIÓN DEL CARRITO DE PEDIDOS -->
                <div class="mt-8 pt-4 border-t border-gray-300">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">2. Carrito de Pedido (<span id="cart-item-count">0</span> kg)</h2>
                    
                    <!-- FIX: Mover el mensaje de carrito vacío fuera del contenedor dinámico -->
                    <p id="empty-cart-message" class="text-gray-500 italic text-sm mb-4">El carrito está vacío. Añade productos desde el análisis.</p>
                    
                    <div id="cart-summary" class="space-y-3 min-h-20">
                        <!-- El resumen del carrito se inserta aquí por JS -->
                    </div>
                    
                    <button id="send-order-btn" onclick="sendWhatsAppOrder()" class="mt-4 w-full bg-green-600 text-white p-3 rounded-lg font-bold hover:bg-green-700 transition duration-150 hidden">
                        <span class="flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2">
                                <path d="M4.5 4.5A3 3 0 0 0 1.5 7.5v9a3 3 0 0 0 3 3h8.25a3 3 0 0 0 3-3V7.5a3 3 0 0 0-3-3H4.5ZM19.5 6a1.5 1.5 0 0 0-1.5-1.5H15v12a3 3 0 0 0 3 3h.75a3 3 0 0 0 3-3v-9a1.5 1.5 0 0 0-1.5-1.5h-1.5Z" />
                            </svg>
                            Enviar Pedido por WhatsApp
                        </span>
                    </button>
                </div>

            </aside>

            <!-- Contenido Principal / Resultados -->
            <main class="lg:w-3/4 p-6">
                <h2 id="main-title" class="text-2xl font-bold mb-4 text-gray-700">Selecciona un producto para empezar...</h2>
                
                <!-- Contenedor de Detalles de Recetas -->
                <div id="recipe-details" class="hidden">

                    <!-- BOTÓN AÑADIR AL CARRITO -->
                    <button 
                        onclick="addToCart(selectedProductKey)" 
                        class="mb-6 p-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-150 flex items-center shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 mr-2">
                            <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM18.75 16.5c.9-.534 1.5-1.407 1.5-2.45v-1.293a1.5 1.5 0 0 0-1.406-.995c-.328-.014-.654.008-.981.077l-1.921.378-.616 3.016a1.2 1.2 0 0 1-1.17 1.055H12a2.25 2.25 0 0 1-2.25-2.25v-1.5a.75.75 0 0 1 1.5 0v1.5c0 .348.283.625.625.625h2.463c.254 0 .478-.15.58-.383l.89-4.364a1.867 1.867 0 0 0-.154-.484l-.56-.933a1.5 1.5 0 0 0-.85-.596l-.94-.216a2.25 2.25 0 0 1-1.636-.58l-1.558-1.378a2.25 2.25 0 0 0-1.636-.58 3.75 3.75 0 0 0-3.23 2.054L2.4 14.25c-.244.757.247 1.5 1.018 1.5h15.282Z" clip-rule="evenodd" />
                        </svg>
                        Añadir 1 kg de <span id="add-to-cart-product-name" class="font-extrabold ml-1">...</span>
                    </button>
                    
                    <p class="text-gray-600 mb-6">Elige una opción de menú para ver raciones, costes y margen por unidad.</p>
                    
                    <div class="overflow-x-auto shadow-lg rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-3 py-3 text-left table-header rounded-tl-lg">Opción de Receta</th>
                                    <th class="px-3 py-3 text-center table-header">Raciones (1kg)</th>
                                    <th class="px-3 py-3 text-center table-header">Coste Producto (€)</th>
                                    <th class="px-3 py-3 text-center table-header">Venta Sugerida (€)</th>
                                    <th class="px-3 py-3 text-center table-header">Margen Bruto (€)</th>
                                    <th class="px-3 py-3 text-center table-header rounded-tr-lg">Rentabilidad (%)</th>
                                </tr>
                            </thead>
                            <tbody id="recipe-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Las filas de recetas se insertarán aquí por JS -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-8 p-4 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 rounded-lg">
                        <p class="font-semibold">Nota Importante:</p>
                        <p class="text-sm">El "Coste Producto" es el gasto del producto base de 12€/kg en la ración. Los costes fijos (pan, guarnición extra, aceite, etc.) se han asumido como un valor fijo en el cálculo del Margen Bruto.</p>
                    </div>
                </div>
            </main>
        </div>

    </div>

    <script>
        // Declaración de variables globales de datos
        const PRODUCT_COST_PER_KG = 12.00; // 12€ por 1 kg

        // Carrito de pedidos: Almacena { key, name, quantity, price }
        let cart = []; 
        let selectedProductKey = null;

        const PRODUCTS = {
            'ensaladilla-rusa': {
                name: 'Ensaladilla Rusa',
                recipes: [
                    { id: 1, name: 'Tapa Clásica y Picos', portionSizeKg: 0.150, sellingPricePerPortion: 4.50, fixedCostPerPortion: 0.50 },
                    { id: 2, name: 'Ensaladilla Marina de Luxe', portionSizeKg: 0.180, sellingPricePerPortion: 6.00, fixedCostPerPortion: 0.80 },
                    { id: 3, name: 'Ración con Gamba y Mahonesa Trufada', portionSizeKg: 0.200, sellingPricePerPortion: 7.50, fixedCostPerPortion: 1.20 }
                ]
            },
            'calamar-con-tomate': {
                name: 'Calamar con Tomate',
                recipes: [
                    { id: 4, name: 'Tosta de Calamar con Alioli Suave', portionSizeKg: 0.120, sellingPricePerPortion: 5.50, fixedCostPerPortion: 0.75 },
                    { id: 5, name: 'Cazuela de Calamar y Arroz Seco', portionSizeKg: 0.250, sellingPricePerPortion: 9.00, fixedCostPerPortion: 1.50 },
                    { id: 6, name: 'Pincho Calamar Picante y Pimentón', portionSizeKg: 0.090, sellingPricePerPortion: 4.00, fixedCostPerPortion: 0.40 }
                ]
            },
            'magra-con-tomate': {
                name: 'Magra con Tomate',
                recipes: [
                    { id: 7, name: 'Bocadillo de Magra Gourmet', portionSizeKg: 0.180, sellingPricePerPortion: 7.00, fixedCostPerPortion: 1.00 },
                    { id: 8, name: 'Ración de Magra con Huevo Frito', portionSizeKg: 0.220, sellingPricePerPortion: 9.50, fixedCostPerPortion: 1.50 },
                    { id: 9, name: 'Tostada de Magra para Desayunos', portionSizeKg: 0.100, sellingPricePerPortion: 4.00, fixedCostPerPortion: 0.50 }
                ]
            },
            'pollo-a-la-almendra': {
                name: 'Pollo a la Almendra',
                recipes: [
                    { id: 10, name: 'Plato Combinado Oriental con Arroz', portionSizeKg: 0.200, sellingPricePerPortion: 8.50, fixedCostPerPortion: 1.00 },
                    { id: 11, name: 'Ración para Menú del Día', portionSizeKg: 0.250, sellingPricePerPortion: 10.00, fixedCostPerPortion: 1.50 },
                    { id: 12, name: 'Copa de Degustación', portionSizeKg: 0.100, sellingPricePerPortion: 5.00, fixedCostPerPortion: 0.70 }
                ]
            },
            'solomillo-px': {
                name: 'Solomillo PX',
                recipes: [
                    { id: 13, name: 'Tapa de Solomillo PX con Patatas Paja', portionSizeKg: 0.080, sellingPricePerPortion: 6.50, fixedCostPerPortion: 0.80 },
                    { id: 14, name: 'Ración de Solomillo PX con Puré', portionSizeKg: 0.150, sellingPricePerPortion: 12.00, fixedCostPerPortion: 1.50 },
                    { id: 15, name: 'Pincho de Solomillo al Estilo Montadito', portionSizeKg: 0.060, sellingPricePerPortion: 4.80, fixedCostPerPortion: 0.60 }
                ]
            }
        };

        /**
         * Calcula las métricas de rentabilidad para una receta específica.
         */
        function calculateMetrics(recipe) {
            // 1. Raciones (Servings): 1 kg / tamaño de la ración
            const servings = Math.floor(1 / recipe.portionSizeKg);

            // 2. Coste del Producto por Ración: Coste por kg * peso de la ración
            const productCostPerPortion = PRODUCT_COST_PER_KG * recipe.portionSizeKg;

            // 3. Coste Total de la Ración (Food Cost): Coste del Producto + Costes fijos (pan, guarnición, etc.)
            const totalCostPerPortion = productCostPerPortion + recipe.fixedCostPerPortion;

            // 4. Margen Bruto: Precio de Venta - Coste Total
            const grossMargin = recipe.sellingPricePerPortion - totalCostPerPortion;
            
            // 5. Rentabilidad (%): (Margen Bruto / Precio de Venta) * 100
            const profitabilityPercentage = (grossMargin / recipe.sellingPricePerPortion) * 100;
            
            return {
                servings: servings,
                productCost: productCostPerPortion.toFixed(2),
                totalCost: totalCostPerPortion.toFixed(2),
                grossMargin: grossMargin.toFixed(2),
                profitability: profitabilityPercentage.toFixed(1)
            };
        }

        /**
         * Renderiza la lista de botones de productos en el sidebar.
         */
        function renderProductList() {
            const productListDiv = document.getElementById('product-list');
            productListDiv.innerHTML = ''; // Limpiar lista
            
            Object.keys(PRODUCTS).forEach(key => {
                const product = PRODUCTS[key];
                const button = document.createElement('button');
                button.textContent = product.name;
                // Mantener el estilo para seleccionar y analizar
                button.className = `product-button w-full text-left p-3 rounded-lg text-gray-700 bg-gray-100 hover:bg-gray-200`;
                button.onclick = () => selectProduct(key);
                button.setAttribute('data-key', key);
                productListDiv.appendChild(button);
            });
        }

        /**
         * Actualiza la interfaz al seleccionar un nuevo producto.
         */
        function selectProduct(key) {
            selectedProductKey = key;
            const product = PRODUCTS[key];
            
            // 1. Actualizar el título principal
            document.getElementById('main-title').textContent = `Análisis de Rentabilidad para: ${product.name}`;
            
            // 2. Actualizar el nombre del producto en el botón de añadir al carrito
            document.getElementById('add-to-cart-product-name').textContent = product.name;

            // 3. Mostrar el contenedor de detalles
            document.getElementById('recipe-details').classList.remove('hidden');

            // 4. Actualizar la lista de botones activos (estilo de selección)
            document.querySelectorAll('.product-button').forEach(btn => {
                btn.classList.remove('active', 'bg-green-600', 'text-white', 'hover:bg-green-500');
                btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');

                if (btn.getAttribute('data-key') === key) {
                    btn.classList.add('active', 'bg-green-600', 'text-white', 'hover:bg-green-500');
                    btn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
                }
            });

            // 5. Renderizar la tabla de recetas
            renderRecipeTable(product.recipes);
        }

        /**
         * Renderiza la tabla con las recetas y métricas calculadas.
         */
        function renderRecipeTable(recipes) {
            const tableBody = document.getElementById('recipe-table-body');
            tableBody.innerHTML = ''; // Limpiar tabla
            
            recipes.forEach(recipe => {
                const metrics = calculateMetrics(recipe);
                
                // Determinar el color de la rentabilidad
                let profitColor = 'text-gray-700';
                if (parseFloat(metrics.profitability) >= 50) {
                    profitColor = 'text-green-600 font-bold';
                } else if (parseFloat(metrics.profitability) < 30) {
                    profitColor = 'text-red-500';
                }

                const row = `
                    <tr class="data-row">
                        <td class="px-3 py-3 font-semibold text-gray-900 whitespace-nowrap">${recipe.name}</td>
                        <td class="px-3 py-3 text-center text-gray-600">${metrics.servings}</td>
                        <td class="px-3 py-3 text-center text-gray-600">${metrics.productCost} €</td>
                        <td class="px-3 py-3 text-center text-green-700 font-medium">${recipe.sellingPricePerPortion.toFixed(2)} €</td>
                        <td class="px-3 py-3 text-center text-blue-600">${metrics.grossMargin} €</td>
                        <td class="px-3 py-3 text-center ${profitColor}">${metrics.profitability}%</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        
        // --- LÓGICA DEL CARRITO ---

        /**
         * Añade una unidad (1kg) del producto seleccionado al carrito.
         * @param {string} key - Clave del producto seleccionado.
         */
        function addToCart(key) {
            if (!key) return; 

            const product = PRODUCTS[key];
            const existingItem = cart.find(item => item.key === key);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({
                    key: key,
                    name: product.name,
                    quantity: 1,
                    price: PRODUCT_COST_PER_KG 
                });
            }
            renderCart();
            // Opcional: Feedback visual simple
            alert(`¡Añadido 1 kg de ${product.name} al carrito!`);
        }

        /**
         * Elimina una unidad del producto del carrito, o lo elimina si la cantidad es 1.
         * @param {string} key - Clave del producto a modificar.
         */
        function removeFromCart(key) {
            const itemIndex = cart.findIndex(item => item.key === key);
            if (itemIndex > -1) {
                cart[itemIndex].quantity -= 1;
                if (cart[itemIndex].quantity <= 0) {
                    cart.splice(itemIndex, 1); // Elimina el producto si la cantidad llega a 0
                }
            }
            renderCart();
        }

        /**
         * Renderiza el resumen del carrito en el sidebar.
         */
        function renderCart() {
            const cartSummaryDiv = document.getElementById('cart-summary');
            const cartItemCountSpan = document.getElementById('cart-item-count');
            const sendOrderBtn = document.getElementById('send-order-btn');
            const emptyMessage = document.getElementById('empty-cart-message');

            // Comprobación de existencia por si el DOM aún no está listo, aunque con window.onload no debería pasar.
            if (!cartSummaryDiv || !cartItemCountSpan || !sendOrderBtn || !emptyMessage) {
                console.error("No se encontraron todos los elementos del carrito en el DOM.");
                return;
            }


            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartItemCountSpan.textContent = totalItems;

            if (cart.length === 0) {
                cartSummaryDiv.innerHTML = '';
                emptyMessage.classList.remove('hidden'); // Mostrar el mensaje de carrito vacío
                sendOrderBtn.classList.add('hidden');
                return;
            }

            emptyMessage.classList.add('hidden'); // Ocultar el mensaje de carrito vacío
            sendOrderBtn.classList.remove('hidden');

            let html = '';
            let totalCost = 0;

            cart.forEach(item => {
                const itemTotal = item.quantity * item.price;
                totalCost += itemTotal;
                
                // Elemento visual para cada producto en el carrito
                html += `
                    <div class="flex justify-between items-center p-2 bg-white rounded-lg border border-gray-200 shadow-sm">
                        <div class="flex-1">
                            <span class="font-medium text-gray-800">${item.name}</span>
                            <div class="text-xs text-gray-500">${item.quantity} kg x ${item.price.toFixed(2)} €</div>
                        </div>
                        <div class="text-right font-bold text-gray-900">${itemTotal.toFixed(2)} €</div>
                        
                        <!-- Botón para reducir cantidad / eliminar -->
                        <button onclick="removeFromCart('${item.key}')" class="ml-2 text-red-500 hover:text-red-700 p-1 rounded-full bg-red-100 transition duration-150" title="Eliminar 1 kg">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                                <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
            });

            // Total del carrito
            html += `
                <div class="mt-4 pt-2 border-t border-gray-300 flex justify-between font-extrabold text-lg text-gray-900">
                    <span>TOTAL ESTIMADO:</span>
                    <span>${totalCost.toFixed(2)} €</span>
                </div>
            `;
            
            cartSummaryDiv.innerHTML = html;
        }

        /**
         * Genera el mensaje de pedido y abre WhatsApp.
         */
        function sendWhatsAppOrder() {
            // --- PERSONALIZA ESTOS VALORES ---
            const commercialName = "Comercial Horeca"; 
            const phoneNumber = "34600000000"; // Reemplaza con el número de teléfono del comercial (código de país + número)
            // ---------------------------------
            
            let message = `¡Hola ${commercialName}!%0A%0AMe gustaría realizar un pedido de los siguientes productos de V Gama:%0A%0A`;
            let totalItems = 0;
            let totalCost = 0;

            cart.forEach(item => {
                message += `* ${item.quantity} kg de ${item.name} (${(item.quantity * item.price).toFixed(2)} € estimado)%0A`;
                totalItems += item.quantity;
                totalCost += item.quantity * item.price;
            });

            message += `%0A*Total de productos:* ${totalItems} kg`;
            message += `%0A*Total estimado:* ${totalCost.toFixed(2)} €`;
            message += `%0A%0A¡Muchas gracias!%0A(Pedido generado desde el Gestor de Rentabilidad)`;

            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }


        // Inicialización de la aplicación al cargar la página
        window.onload = function() {
            renderProductList();
            renderCart(); // Inicializa el carrito vacío
            
            // Seleccionar el primer producto automáticamente al cargar
            const firstProductKey = Object.keys(PRODUCTS)[0];
            if (firstProductKey) {
                selectProduct(firstProductKey);
            }
        };

    </script>
</body>
</html>
